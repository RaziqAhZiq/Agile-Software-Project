<!DOCTYPE html>
<html lang="en">
<head>
    <%- include ('base/head'); %>
    <title>Bookings Page</title>
    <link rel="stylesheet" href="/stylesheets/bookings-style.css">
</head>
<body>
    <%- include ('base/navbar'); %>

    <div class="container">
        <div class="row mt-4">
            <div class="col-md-12">
                <h2>Flight Bookings</h2>
            </div>
        </div>
        <ul class="list-unstyled">
            <% flightBookings.forEach(data => { %>
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <img src="<%= data.carrierLogo %>" alt="<%= data.carrierName %> Logo" width="30" class="me-2">
                                <h5 class="mb-0"><%= data.carrierName %></h5>
                            </div>
                            <button class="btn btn-danger flight-booking-button" onclick="deleteBooking('flights', '<%= data.bookingId %>')">Delete</button>
                        </div>
                    </div>
                    <div class="card-body d-flex flex-column justify-content-between">
                        <% if (data.tripType === 'one-way') { %>
                            <div class="leg-item">
                                <div class="leg-info">
                                    <div class="row">
                                        <div class="col text-center">
                                            <h3><%= data.origin %> to <%= data.destination %></h3>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col text-center">
                                            <span class="fs-5"><%= formatDate(data.departure) %></span>
                                            <span class="line flex-grow-1"></span>
                                            <span class="fs-5"><%= formatDate(data.arrival) %></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col text-center"></div>
                                        <div class="col text-center">
                                            <div class="d-flex justify-content-center align-items-center h-100">
                                                <span><%= convertToHoursAndMinutes(data.duration) %>, <%= data.stop %> Stops</span>
                                            </div>
                                        </div>
                                        <div class="col text-end">
                                            <h5><%= data.price %></h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="leg-item">
                                <div class="leg-info">
                                    <div class="row">
                                        <div class="col text-center">
                                            <h3><%= data.origin1 %> to <%= data.destination1 %></h3>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col text-center">
                                            <span class="fs-5"><%= formatDate(data.departure1) %></span>
                                            <span class="line flex-grow-1"></span>
                                            <span class="fs-5"><%= formatDate(data.arrival1) %></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col text-center">
                                            <div>
                                                <span><%= convertToHoursAndMinutes(data.duration1) %>, <%= data.stop1 %> Stops</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="leg-info">
                                    <div class="row mt-1">
                                        <div class="col text-center">
                                            <h3><%= data.origin2 %> to <%= data.destination2 %></h3>
                                        </div>
                                    </div>
                                    <div class="row mt-1">
                                        <div class="col text-center">
                                            <span class="fs-5"><%= formatDate(data.departure2) %></span>
                                            <span class="line flex-grow-1"></span>
                                            <span class="fs-5"><%= formatDate(data.arrival2) %></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col text-center"></div>
                                        <div class="col text-center">
                                            <div>
                                                <span><%= convertToHoursAndMinutes(data.duration2) %>, <%= data.stop2 %> Stops</span>
                                            </div>
                                        </div>
                                        <div class="col text-end">
                                            <h5><%= data.price %></h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% }) %>
            <% if (flightBookings.length == 0) { %>
                <div class="alert alert-warning">
                    No flight bookings.
                </div>
            <% } %>
        </ul>
    </div>

    <div class="container">
        <div class="row mt-5">
            <div class="col-md-12">
                <h2>Airbnb Bookings</h2>
            </div>
        </div>
        <div class="booking-list">
            <% airbnbBookings.forEach(entry => { %>
                <div class="booking-item">
                    <img src="<%= entry.airbnbImage %>" class="booking-image">
                    <div class="booking-details">
                        <h3><%= entry.airbnbName %></h3>
                        <span>Check-in: <%= entry.checkIn %></span><br>
                        <span>Check-out: <%= entry.checkOut %></span><br>
                        <% if (entry.itineraryId && entry.itineraryId != "") { %>
                            <span>Itinerary: <%= entry.itineraryName %> <a onclick="displayModal('<%= entry.bookingId %>', '<%= entry.itineraryId %>')" class="link">Change</a></span><br>
                        <% } else { %>
                            <span>Itinerary: <a onclick="displayModal('<%= entry.bookingId %>', '')" class="link">Add</a></span><br>
                        <% } %>
                        <div class="booking-button-container">
                            <form action="/airbnb/<%= entry.airbnbId %>" method="GET">
                                <button type="submit" class="btn btn-primary booking-button">View listing</button>
                            </form>
                            <button onclick="deleteBooking('airbnb', '<%= entry.bookingId %>')" class="btn btn-danger booking-button">Delete</button>
                        </div>
                    </div>
                </div>
            <% }) %>
            <% if (airbnbBookings.length == 0) { %>
                <p>No airbnb bookings.</p>
            <% } %>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <form id="addToItineraryForm">
                <div class="modal-header">
                    <button type="button" class="btn-close" onclick="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <h4 class="h4-black">Which itinerary would you like to add your booking to?</h4>
                    <select class="itinerary-dropdown" id="itineraryDropdown"></select>
                    <div class="create-itinerary-form" id="createItineraryForm"><br>
                        <div class="d-flex align-items-center">
                            <h4 class="h4-black">Trip Name</h4>
                        </div>
                        <input type="text" id="trip-name" class="form-control" placeholder="e.g. Trip to Bali" /><br>
                        <div class="d-flex align-items-center">
                            <h4 class="h4-black">Destination</h4>
                        </div>
                        <div class="input-group position-relative">
                            <input type="text" id="trip-destination" class="form-control" placeholder="Where to?" />
                            <button type="button" id="add-destination-button" class="btn btn-secondary rounded-end" onclick="addDestination()">Add destination</button>
                            <div id="dropdown" class="dropdown-menu position-absolute w-100"></div>
                        </div>
                        <div id="selected-destinations" class="d-flex flex-wrap"></div><br>
                        <div class="d-flex align-items-center">
                            <h4 class="h4-black">Dates</h4>
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">From:</span>
                            <input type="date" id="trip-from-date" class="form-control" />
                            <span class="input-group-text">To:</span>
                            <input type="date" id="trip-to-date" class="form-control" />
                        </div>
                    </div>
                    <input type="hidden" id="bookingId" />
                    <input type="hidden" id="itineraryId" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <%- include ('base/footer'); %>

    <% function formatDate(date) {
        const options = {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false
        };
        const formattedDate = new Date(date).toLocaleString('en-US', options);
        return formattedDate.replace('24:', '00:');
    } %>
    
    <% function convertToHoursAndMinutes(minutes) {
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        if (hours === 0) {
            return `${remainingMinutes}m`;
        }
        if (remainingMinutes === 0) {
            return `${hours}h`;
        }
        return `${hours}h ${remainingMinutes}m`;
    } %>
</body>
</html>
<script>
    // Delete booking
    function deleteBooking(bookingType, bookingId) {
        if (confirm("Are you sure you want to delete this booking?")) {
            fetch(`/bookings/delete/${bookingType}/${bookingId}`, {method: "DELETE"})
            .then(response => {
                fetch("/itinerary/trip/destinations").then(response => response.json()).then(trips => {
                    trips.forEach(trip => {
                        if (trip.bookings[bookingType].indexOf(bookingId) != -1) {
                            trip.bookings[bookingType].splice(trip.bookings[bookingType].indexOf(bookingId), 1);
                            $.ajax({
                                url: `/itinerary/trip/<%= user.uid %>/destinations/${trip.id}`,
                                type: "PUT",
                                data: JSON.stringify(trip),
                                contentType: "application/json",
                                success: function(response) {

                                },
                                error: function(error) {
                                    console.error(`An error occurred while deleting ${bookingId} from ${trip.id}.`);
                                }
                            });
                        }
                    });
                    window.location.reload();
                });
            });
        }
    }

    // Display modal
    function displayModal(bookingId, itineraryId) {
        var modal = document.getElementById("modal");
        modal.style.display = "block";
        var bookingIdInput = document.getElementById("bookingId");
        bookingIdInput.value = bookingId;
        var itineraryIdInput = document.getElementById("itineraryId");
        itineraryIdInput.value = itineraryId;
        fetch("/itinerary/trip/destinations").then(response => response.json()).then(trips => {
            var itineraryDropdownOptions = "";
            trips.forEach(trip => {
                if (trip.id != itineraryId) {
                    itineraryDropdownOptions += `<option value="${trip.id}">${trip.tripName}</option>`;
                }
            });
            itineraryDropdownOptions += "<option>Create new itinerary</option>";
            if (itineraryId != "") {
                itineraryDropdownOptions += "<option>Remove from itinerary</option>";
            }
            var itineraryDropdown = document.getElementById("itineraryDropdown");
            itineraryDropdown.innerHTML = itineraryDropdownOptions;
        });
    }

    // Close modal
    function closeModal() {
        var modal = document.getElementById("modal");
        modal.style.display = "none";
    }

    // Toggle dropdown arrow based on whether options are displayed
    var itineraryDropdown = document.getElementById("itineraryDropdown");
    document.onclick = function(e) {
        // if dropdown options hidden, blur itineraryDropdown
    }
    itineraryDropdown.onchange = function(e) {
        itineraryDropdown.blur();
        createItineraryFormVisible();
    }
    itineraryDropdown.onfocus = function(e) {
        itineraryDropdown.style.backgroundImage = "url('/images/up-arrow.png')";
    }
    itineraryDropdown.onblur = function(e) {
        itineraryDropdown.style.backgroundImage = "url('/images/down-arrow.png')";
    }

    // Show/hide create itinerary form in modal based on dropdown selection
    function createItineraryFormVisible() {
        var itineraryDropdown = document.getElementById("itineraryDropdown");
        var createItineraryForm = document.getElementById("createItineraryForm");
        var tripName = document.getElementById("trip-name");
        var tripFromDate = document.getElementById("trip-from-date");
        var tripToDate = document.getElementById("trip-to-date");
        if (itineraryDropdown.options[itineraryDropdown.selectedIndex].innerText == "Create new itinerary") {
            createItineraryForm.style.display = "block";
            tripName.required = true;
            tripFromDate.required = true;
            tripToDate.required = true;
        }
        else {
            createItineraryForm.style.display = "none";
            tripName.required = false;
            tripFromDate.required = false;
            tripToDate.required = false;
        }
    }

    var citiesAndCountries;
    var addedDestinations = [];

    // Destination suggestions
    $.getJSON("/data/airports.json", function(data) {
        citiesAndCountries = data.map(item => ({
            city: item.City,
            country: item.Country
        }));
        citiesAndCountries = citiesAndCountries.filter((value, index, self) => index == self.findIndex((v) => (v.city == value.city && v.country == value.country)));
    });
    $("#trip-destination").on("input", function() {
        const query = $(this).val().toLowerCase();
        const filteredOptions = citiesAndCountries.filter(item => item.city.toLowerCase().includes(query) || item.country.toLowerCase().includes(query));
        updateDropdown(filteredOptions.slice(0, 5));
    });
    function updateDropdown(options) {
        var $dropdown = $("#dropdown");
        $dropdown.empty();
        if (options.length > 0) {
            $dropdown.show();
        } 
        else {
            $dropdown.hide();
        }
        options.forEach(item => {
            var optionDiv = $("<div>").addClass("dropdown-item").text(`${item.city}, ${item.country}`);
            optionDiv.on("click", function() {
                $("#trip-destination").val(`${item.city}, ${item.country}`);
                $dropdown.hide();
            });
            $dropdown.append(optionDiv);
        });
    }
    $(document).on("click", function() {
        $("#dropdown").hide();
    });

    // Add destination
    function addDestination() {
        if (addedDestinations.length >= 5) {
            alert("You can only add up to 5 destinations at one time.");
        }
        var selectedDestination = $("#trip-destination").val();
        if (selectedDestination && !addedDestinations.includes(selectedDestination)) {
            addedDestinations.push(selectedDestination);
            var destinationInput = $("<input>").attr("type", "text").attr("readonly", true).addClass("form-control").val(selectedDestination);
            var deleteButton = $("<button>").text("Delete").addClass("btn btn-danger rounded-end").on("click", function() {
                var index = addedDestinations.indexOf(selectedDestination);
                addedDestinations.splice(index, 1);
                $(this).closest(".input-group").remove();
            });
            var hiddenInput = $("<input>").attr("type", "hidden").attr("name", "destinations").val(selectedDestination);
            var inputGroup = $("<div>").addClass("input-group mb-3").css({"width": "auto", "margin-right": "10px", "margin-top": "10px"}).append(destinationInput, deleteButton, hiddenInput);
            $("#selected-destinations").append(inputGroup);
            $("#trip-destination").val(""); 
        }
    }

    // Add booking to itinerary
    $("#addToItineraryForm").on("submit", function(e) {
        e.preventDefault();
        var itineraryDropdown = document.getElementById("itineraryDropdown");
        var bookingIdInput = document.getElementById("bookingId");
        var itineraryIdInput = document.getElementById("itineraryId");
        // If adding to existing itinerary
        if (itineraryDropdown.options[itineraryDropdown.selectedIndex].innerText != "Create new itinerary" && itineraryDropdown.options[itineraryDropdown.selectedIndex].innerText != "Remove from itinerary") {
            // Add itinerary ID to booking
            var itineraryId = itineraryDropdown.options[itineraryDropdown.selectedIndex].value;
            $.ajax({
                url: `/bookings/update/airbnb/${bookingIdInput.value}`,
                type: "PUT",
                data: JSON.stringify({itineraryId: itineraryId}),
                contentType: "application/json",
                success: function(response) {
                    // Add booking ID to itinerary
                    fetch("/itinerary/trip/destinations").then(response => response.json()).then(trips => {
                        trips.forEach(trip => {
                            if (trip.id == itineraryId) {
                                trip.bookings.airbnb.push(bookingIdInput.value);
                                $.ajax({
                                    url: `/itinerary/trip/<%= user.uid %>/destinations/${itineraryId}`,
                                    type: "PUT",
                                    data: JSON.stringify(trip),
                                    contentType: "application/json",
                                    success: function(response) {
                                        alert("Booking added to itinerary!");
                                        window.location.reload();
                                    },
                                    error: function(error) {
                                        alert("An error occurred while adding booking ID to itinerary.");
                                    }
                                });
                            }
                        });
                    });
                },
                error: function(error) {
                    alert("An error occurred while adding itinerary ID to booking.");
                }
            });
        }
        // If adding to new itinerary
        else if (itineraryDropdown.options[itineraryDropdown.selectedIndex].innerText == "Create new itinerary") {
            if (addedDestinations.length == 0) {
                alert("Please add at least one destination.");
            }
            else {
                // Create new itinerary and add booking ID to itinerary
                $.post("/itinerary/trip/<%= user.uid %>/destinations", {destinations: addedDestinations,
                                                                            tripName: $("#trip-name").val(),
                                                                            fromDate: $("#trip-from-date").val(),
                                                                            toDate: $("#trip-to-date").val(),
                                                                            bookings: {flights: [], hotel: [], airbnb: [bookingIdInput.value]}}, function(response) {
                    // Add itinerary ID to booking
                    var itineraryId = response.itineraryId;
                    $.ajax({
                        url: `/bookings/update/airbnb/${bookingIdInput.value}`,
                        type: "PUT",
                        data: JSON.stringify({itineraryId: itineraryId}),
                        contentType: "application/json",
                        success: function(response) {
                            alert("Booking added to itinerary!");
                            window.location.reload();
                        },
                        error: function(error) {
                            alert("An error occurred while adding to itinerary.");
                        }
                    });
                });
            }
        }
        // If removing from itinerary
        else {
            // Remove itinerary ID from booking
            $.ajax({
                url: `/bookings/update/airbnb/${bookingIdInput.value}`,
                type: "PUT",
                data: JSON.stringify({itineraryId: ""}),
                contentType: "application/json",
                success: function(response) {
                    // Remove booking ID from itinerary
                    fetch("/itinerary/trip/destinations").then(response => response.json()).then(trips => {
                        trips.forEach(trip => {
                            if (trip.id == itineraryIdInput.value) {
                                trip.bookings.airbnb.filter(item => item != bookingIdInput.value);
                                $.ajax({
                                    url: `/itinerary/trip/<%= user.uid %>/destinations/${itineraryIdInput.value}`,
                                    type: "PUT",
                                    data: JSON.stringify(trip),
                                    contentType: "application/json",
                                    success: function(response) {
                                        alert("Booking removed from itinerary!");
                                        window.location.reload();
                                    },
                                    error: function(error) {
                                        alert("An error occurred while removing booking ID from itinerary.");
                                    }
                                });
                            }
                        });
                    });
                },
                error: function(error) {
                    alert("An error occurred while removing itinerary ID from booking.");
                }
            });
        }
    });
</script>